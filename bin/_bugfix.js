"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("upath2");
const fs = require("fs-extra");
const config_1 = require("@node-novel/task/lib/config");
const novel_stat_1 = require("../lib/cache/novel-stat");
const project_config_1 = require("../project.config");
const moment = require("moment");
const FastGlob = require("fast-glob");
/**
 * Created by user on 2018/7/22/022.
 */
exports.PROJECT_ROOT = project_config_1.default.project_root;
exports.MyConfig = config_1.loadMainConfig(exports.PROJECT_ROOT);
exports.CacheConfig = config_1.loadCacheConfig(exports.PROJECT_ROOT);
exports.GITEE_TOKEN = process.env.GITEE_TOKEN || '';
exports.DIST_NOVEL = project_config_1.default.novel_root;
console.time('bugfix');
let ls = FastGlob.sync([
    'docs/*.json',
], {
    cwd: path.join(project_config_1.default.cache_root, 'files'),
    absolute: true,
    onlyFiles: true,
});
if (ls.length) {
    ls.forEach(function (file) {
        console.log('[delete]', file);
        fs.removeSync(file);
    });
}
{
    let now = moment();
    let now_unix = now.unix();
    const novelStatCache = novel_stat_1.getNovelStatCache();
    let _ok;
    Object.entries(novelStatCache.data.history)
        .forEach(function ([timestamp, stat]) {
        let n_timestamp = parseInt(timestamp);
        if (now_unix >= n_timestamp) {
            let ms = moment.unix(n_timestamp).valueOf();
            delete novelStatCache.data.history[timestamp];
            novelStatCache.data.history[ms] = stat;
            _ok = true;
        }
    });
    if (_ok) {
        novelStatCache.save();
    }
}
console.timeEnd('bugfix');
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX2J1Z2ZpeC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIl9idWdmaXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBZ0M7QUFJaEMsK0JBQStCO0FBRy9CLHdEQUEwRjtBQUUxRix3REFBNEQ7QUFDNUQsc0RBQThDO0FBQzlDLGlDQUFrQztBQUNsQyxzQ0FBc0M7QUFFdEM7O0dBRUc7QUFFVSxRQUFBLFlBQVksR0FBRyx3QkFBYSxDQUFDLFlBQVksQ0FBQztBQUU1QyxRQUFBLFFBQVEsR0FBRyx1QkFBYyxDQUFDLG9CQUFZLENBQUMsQ0FBQztBQUN4QyxRQUFBLFdBQVcsR0FBRyx3QkFBZSxDQUFDLG9CQUFZLENBQUMsQ0FBQztBQUU1QyxRQUFBLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7QUFDMUMsUUFBQSxVQUFVLEdBQUcsd0JBQWEsQ0FBQyxVQUFVLENBQUM7QUFFbkQsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUV2QixJQUFJLEVBQUUsR0FBYSxRQUFRLENBQUMsSUFBSSxDQUFDO0lBQ2hDLGFBQWE7Q0FDYixFQUFFO0lBQ0YsR0FBRyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQWEsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO0lBQ2pELFFBQVEsRUFBRSxJQUFJO0lBQ2QsU0FBUyxFQUFFLElBQUk7Q0FDZixDQUFDLENBQUM7QUFFSCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQ2I7SUFDQyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSTtRQUV4QixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5QixFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3BCLENBQUMsQ0FBQyxDQUFBO0NBQ0Y7QUFFRDtJQUNDLElBQUksR0FBRyxHQUFHLE1BQU0sRUFBRSxDQUFDO0lBQ25CLElBQUksUUFBUSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUUxQixNQUFNLGNBQWMsR0FBRyw4QkFBaUIsRUFBRSxDQUFDO0lBRTNDLElBQUksR0FBWSxDQUFDO0lBRWpCLE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDekMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDO1FBRW5DLElBQUksV0FBVyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUV0QyxJQUFJLFFBQVEsSUFBSSxXQUFXLEVBQzNCO1lBQ0MsSUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUU1QyxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlDLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUV2QyxHQUFHLEdBQUcsSUFBSSxDQUFDO1NBQ1g7SUFFRixDQUFDLENBQUMsQ0FDRjtJQUVELElBQUksR0FBRyxFQUNQO1FBQ0MsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO0tBQ3RCO0NBQ0Q7QUFFRCxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggPSByZXF1aXJlKCd1cGF0aDInKTtcbmltcG9ydCAqIGFzIGNyb3NzU3Bhd24gZnJvbSAnY3Jvc3Mtc3Bhd24nO1xuaW1wb3J0IGdpdFJvb3QgZnJvbSAnZ2l0LXJvb3QyJztcbmltcG9ydCB7IGNvbmZpZyBhcyBkb3RlbnZDb25maWcgfSBmcm9tICdkb3RlbnYnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgY3Jvc3NTcGF3bkFzeW5jLCBjcm9zc1NwYXduU3luYyB9IGZyb20gJy4uJztcbmltcG9ydCB7IGNyb3NzU3Bhd25PdXRwdXQsIGlzR2l0Um9vdCB9IGZyb20gJy4uL2luZGV4JztcbmltcG9ydCB7IGxvYWRDYWNoZUNvbmZpZywgbG9hZE1haW5Db25maWcsIGxvYWRDb25maWcgfSBmcm9tICdAbm9kZS1ub3ZlbC90YXNrL2xpYi9jb25maWcnO1xuaW1wb3J0IHsgSUNvbmZpZyB9IGZyb20gJ0Bub2RlLW5vdmVsL3Rhc2snO1xuaW1wb3J0IHsgZ2V0Tm92ZWxTdGF0Q2FjaGUgfSBmcm9tICcuLi9saWIvY2FjaGUvbm92ZWwtc3RhdCc7XG5pbXBvcnQgUHJvamVjdENvbmZpZyBmcm9tICcuLi9wcm9qZWN0LmNvbmZpZyc7XG5pbXBvcnQgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XG5pbXBvcnQgKiBhcyBGYXN0R2xvYiBmcm9tICdmYXN0LWdsb2InO1xuXG4vKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzcvMjIvMDIyLlxuICovXG5cbmV4cG9ydCBjb25zdCBQUk9KRUNUX1JPT1QgPSBQcm9qZWN0Q29uZmlnLnByb2plY3Rfcm9vdDtcblxuZXhwb3J0IGxldCBNeUNvbmZpZyA9IGxvYWRNYWluQ29uZmlnKFBST0pFQ1RfUk9PVCk7XG5leHBvcnQgbGV0IENhY2hlQ29uZmlnID0gbG9hZENhY2hlQ29uZmlnKFBST0pFQ1RfUk9PVCk7XG5cbmV4cG9ydCBsZXQgR0lURUVfVE9LRU4gPSBwcm9jZXNzLmVudi5HSVRFRV9UT0tFTiB8fCAnJztcbmV4cG9ydCBjb25zdCBESVNUX05PVkVMID0gUHJvamVjdENvbmZpZy5ub3ZlbF9yb290O1xuXG5jb25zb2xlLnRpbWUoJ2J1Z2ZpeCcpO1xuXG5sZXQgbHM6IHN0cmluZ1tdID0gRmFzdEdsb2Iuc3luYyhbXG5cdCdkb2NzLyouanNvbicsXG5dLCB7XG5cdGN3ZDogcGF0aC5qb2luKFByb2plY3RDb25maWcuY2FjaGVfcm9vdCwgJ2ZpbGVzJyksXG5cdGFic29sdXRlOiB0cnVlLFxuXHRvbmx5RmlsZXM6IHRydWUsXG59KTtcblxuaWYgKGxzLmxlbmd0aClcbntcblx0bHMuZm9yRWFjaChmdW5jdGlvbiAoZmlsZSlcblx0e1xuXHRcdGNvbnNvbGUubG9nKCdbZGVsZXRlXScsIGZpbGUpO1xuXHRcdGZzLnJlbW92ZVN5bmMoZmlsZSlcblx0fSlcbn1cblxue1xuXHRsZXQgbm93ID0gbW9tZW50KCk7XG5cdGxldCBub3dfdW5peCA9IG5vdy51bml4KCk7XG5cblx0Y29uc3Qgbm92ZWxTdGF0Q2FjaGUgPSBnZXROb3ZlbFN0YXRDYWNoZSgpO1xuXG5cdGxldCBfb2s6IGJvb2xlYW47XG5cblx0T2JqZWN0LmVudHJpZXMobm92ZWxTdGF0Q2FjaGUuZGF0YS5oaXN0b3J5KVxuXHRcdC5mb3JFYWNoKGZ1bmN0aW9uIChbdGltZXN0YW1wLCBzdGF0XSlcblx0XHR7XG5cdFx0XHRsZXQgbl90aW1lc3RhbXAgPSBwYXJzZUludCh0aW1lc3RhbXApO1xuXG5cdFx0XHRpZiAobm93X3VuaXggPj0gbl90aW1lc3RhbXApXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBtcyA9IG1vbWVudC51bml4KG5fdGltZXN0YW1wKS52YWx1ZU9mKCk7XG5cblx0XHRcdFx0ZGVsZXRlIG5vdmVsU3RhdENhY2hlLmRhdGEuaGlzdG9yeVt0aW1lc3RhbXBdO1xuXHRcdFx0XHRub3ZlbFN0YXRDYWNoZS5kYXRhLmhpc3RvcnlbbXNdID0gc3RhdDtcblxuXHRcdFx0XHRfb2sgPSB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0fSlcblx0O1xuXG5cdGlmIChfb2spXG5cdHtcblx0XHRub3ZlbFN0YXRDYWNoZS5zYXZlKCk7XG5cdH1cbn1cblxuY29uc29sZS50aW1lRW5kKCdidWdmaXgnKTtcbiJdfQ==