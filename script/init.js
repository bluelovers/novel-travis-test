"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("upath2");
const dotenv_1 = require("dotenv");
const fs = require("fs-extra");
const config_1 = require("@node-novel/task/lib/config");
const project_config_1 = require("../project.config");
const moment = require("moment");
const FastGlob = require("fast-glob");
const log_1 = require("../lib/log");
/**
 * Created by user on 2018/5/17/017.
 */
exports.DEBUG = false;
exports.PROJECT_ROOT = project_config_1.default.project_root;
exports.MyConfig = config_1.loadMainConfig(exports.PROJECT_ROOT);
exports.CacheConfig = config_1.loadCacheConfig(exports.PROJECT_ROOT);
exports.GITEE_TOKEN = process.env.GITEE_TOKEN || '';
exports.GITLAB_TOKEN = process.env.GITLAB_TOKEN || '';
exports.DIST_NOVEL = project_config_1.default.novel_root;
if (!exports.GITEE_TOKEN || !exports.GITLAB_TOKEN) {
    let env = dotenv_1.config({ path: path.join(exports.PROJECT_ROOT, '.env') });
    if (!exports.GITEE_TOKEN && env.parsed && env.parsed.GITEE_TOKEN) {
        exports.GITEE_TOKEN = env.parsed.GITEE_TOKEN;
    }
    if (!exports.GITLAB_TOKEN && env.parsed && env.parsed.GITLAB_TOKEN) {
        exports.GITLAB_TOKEN = env.parsed.GITLAB_TOKEN;
    }
}
exports.CLONE_DEPTH = process.env.CLONE_DEPTH || 50;
if (!/@$/.test(exports.GITEE_TOKEN)) {
    exports.GITEE_TOKEN += '@';
}
if (exports.CacheConfig && exports.CacheConfig.config && exports.CacheConfig.config.done == -1) {
    exports.NOT_DONE = true;
    log_1.default.warn(`上次的任務未完成 本次繼續執行 (1)`);
}
else {
    let ls = FastGlob.sync([
        '*/*.json',
    ], {
        cwd: path.join(project_config_1.default.cache_root, 'files'),
    });
    if (ls.length) {
        exports.NOT_DONE = true;
        log_1.default.warn(`上次的任務未完成 本次繼續執行 (2)`);
        log_1.default.log(ls);
        fs.outputJSONSync(path.join(project_config_1.default.cache_root, 'diff-novel.json'), [], {
            spaces: '\t',
        });
    }
}
exports.BR_NAME = 'auto/' + moment().format('YYYY-MM-DD-HH-mm-ss');
exports.NO_PUSH = exports.MyConfig && exports.MyConfig.config.debug && exports.MyConfig.config.debug.no_push;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBZ0M7QUFFaEMsbUNBQWdEO0FBQ2hELCtCQUErQjtBQUcvQix3REFBMEY7QUFFMUYsc0RBQThDO0FBQzlDLGlDQUFrQztBQUNsQyxzQ0FBc0M7QUFDdEMsb0NBQWlDO0FBRWpDOztHQUVHO0FBRVEsUUFBQSxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBRVosUUFBQSxZQUFZLEdBQUcsd0JBQWEsQ0FBQyxZQUFZLENBQUM7QUFFNUMsUUFBQSxRQUFRLEdBQUcsdUJBQWMsQ0FBQyxvQkFBWSxDQUFDLENBQUM7QUFDeEMsUUFBQSxXQUFXLEdBQUcsd0JBQWUsQ0FBQyxvQkFBWSxDQUFDLENBQUM7QUFFNUMsUUFBQSxXQUFXLEdBQVcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDO0FBQ3BELFFBQUEsWUFBWSxHQUFXLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQztBQUVwRCxRQUFBLFVBQVUsR0FBRyx3QkFBYSxDQUFDLFVBQVUsQ0FBQztBQUVuRCxJQUFJLENBQUMsbUJBQVcsSUFBSSxDQUFDLG9CQUFZLEVBQ2pDO0lBQ0MsSUFBSSxHQUFHLEdBQUcsZUFBWSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQVksRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFbEUsSUFBSSxDQUFDLG1CQUFXLElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFDeEQ7UUFDQyxtQkFBVyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO0tBQ3JDO0lBRUQsSUFBSSxDQUFDLG9CQUFZLElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksRUFDMUQ7UUFDQyxvQkFBWSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO0tBQ3ZDO0NBQ0Q7QUFFVSxRQUFBLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7QUFFdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQVcsQ0FBQyxFQUMzQjtJQUNDLG1CQUFXLElBQUksR0FBRyxDQUFDO0NBQ25CO0FBSUQsSUFBSSxtQkFBVyxJQUFJLG1CQUFXLENBQUMsTUFBTSxJQUFJLG1CQUFXLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsRUFDdEU7SUFDQyxnQkFBUSxHQUFHLElBQUksQ0FBQztJQUVoQixhQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7Q0FDcEM7S0FFRDtJQUNDLElBQUksRUFBRSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDdEIsVUFBVTtLQUNWLEVBQUU7UUFDRixHQUFHLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBYSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUM7S0FDakQsQ0FBQyxDQUFDO0lBRUgsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUNiO1FBQ0MsZ0JBQVEsR0FBRyxJQUFJLENBQUM7UUFDaEIsYUFBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRXBDLGFBQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFaEIsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQzdFLE1BQU0sRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDO0tBQ0g7Q0FDRDtBQUVZLFFBQUEsT0FBTyxHQUFHLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUUzRCxRQUFBLE9BQU8sR0FBRyxnQkFBUSxJQUFJLGdCQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxnQkFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggPSByZXF1aXJlKCd1cGF0aDInKTtcbmltcG9ydCBnaXRSb290IGZyb20gJ2dpdC1yb290Mic7XG5pbXBvcnQgeyBjb25maWcgYXMgZG90ZW52Q29uZmlnIH0gZnJvbSAnZG90ZW52JztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IGNyb3NzU3Bhd25Bc3luYywgY3Jvc3NTcGF3blN5bmMgfSBmcm9tICcuLic7XG5pbXBvcnQgeyBjcm9zc1NwYXduT3V0cHV0LCBpc0dpdFJvb3QgfSBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgeyBsb2FkQ2FjaGVDb25maWcsIGxvYWRNYWluQ29uZmlnLCBsb2FkQ29uZmlnIH0gZnJvbSAnQG5vZGUtbm92ZWwvdGFzay9saWIvY29uZmlnJztcbmltcG9ydCB7IElDb25maWcgfSBmcm9tICdAbm9kZS1ub3ZlbC90YXNrJztcbmltcG9ydCBQcm9qZWN0Q29uZmlnIGZyb20gJy4uL3Byb2plY3QuY29uZmlnJztcbmltcG9ydCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcbmltcG9ydCAqIGFzIEZhc3RHbG9iIGZyb20gJ2Zhc3QtZ2xvYic7XG5pbXBvcnQgY29uc29sZSBmcm9tICcuLi9saWIvbG9nJztcblxuLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC81LzE3LzAxNy5cbiAqL1xuXG5leHBvcnQgbGV0IERFQlVHID0gZmFsc2U7XG5cbmV4cG9ydCBjb25zdCBQUk9KRUNUX1JPT1QgPSBQcm9qZWN0Q29uZmlnLnByb2plY3Rfcm9vdDtcblxuZXhwb3J0IGxldCBNeUNvbmZpZyA9IGxvYWRNYWluQ29uZmlnKFBST0pFQ1RfUk9PVCk7XG5leHBvcnQgbGV0IENhY2hlQ29uZmlnID0gbG9hZENhY2hlQ29uZmlnKFBST0pFQ1RfUk9PVCk7XG5cbmV4cG9ydCBsZXQgR0lURUVfVE9LRU46IHN0cmluZyA9IHByb2Nlc3MuZW52LkdJVEVFX1RPS0VOIHx8ICcnO1xuZXhwb3J0IGxldCBHSVRMQUJfVE9LRU46IHN0cmluZyA9IHByb2Nlc3MuZW52LkdJVExBQl9UT0tFTiB8fCAnJztcblxuZXhwb3J0IGNvbnN0IERJU1RfTk9WRUwgPSBQcm9qZWN0Q29uZmlnLm5vdmVsX3Jvb3Q7XG5cbmlmICghR0lURUVfVE9LRU4gfHwgIUdJVExBQl9UT0tFTilcbntcblx0bGV0IGVudiA9IGRvdGVudkNvbmZpZyh7IHBhdGg6IHBhdGguam9pbihQUk9KRUNUX1JPT1QsICcuZW52JykgfSk7XG5cblx0aWYgKCFHSVRFRV9UT0tFTiAmJiBlbnYucGFyc2VkICYmIGVudi5wYXJzZWQuR0lURUVfVE9LRU4pXG5cdHtcblx0XHRHSVRFRV9UT0tFTiA9IGVudi5wYXJzZWQuR0lURUVfVE9LRU47XG5cdH1cblxuXHRpZiAoIUdJVExBQl9UT0tFTiAmJiBlbnYucGFyc2VkICYmIGVudi5wYXJzZWQuR0lUTEFCX1RPS0VOKVxuXHR7XG5cdFx0R0lUTEFCX1RPS0VOID0gZW52LnBhcnNlZC5HSVRMQUJfVE9LRU47XG5cdH1cbn1cblxuZXhwb3J0IGxldCBDTE9ORV9ERVBUSCA9IHByb2Nlc3MuZW52LkNMT05FX0RFUFRIIHx8IDUwO1xuXG5pZiAoIS9AJC8udGVzdChHSVRFRV9UT0tFTikpXG57XG5cdEdJVEVFX1RPS0VOICs9ICdAJztcbn1cblxuZXhwb3J0IGxldCBOT1RfRE9ORTogYm9vbGVhbjtcblxuaWYgKENhY2hlQ29uZmlnICYmIENhY2hlQ29uZmlnLmNvbmZpZyAmJiBDYWNoZUNvbmZpZy5jb25maWcuZG9uZSA9PSAtMSlcbntcblx0Tk9UX0RPTkUgPSB0cnVlO1xuXG5cdGNvbnNvbGUud2Fybihg5LiK5qyh55qE5Lu75YuZ5pyq5a6M5oiQIOacrOasoee5vOe6jOWft+ihjCAoMSlgKTtcbn1cbmVsc2Vcbntcblx0bGV0IGxzID0gRmFzdEdsb2Iuc3luYyhbXG5cdFx0JyovKi5qc29uJyxcblx0XSwge1xuXHRcdGN3ZDogcGF0aC5qb2luKFByb2plY3RDb25maWcuY2FjaGVfcm9vdCwgJ2ZpbGVzJyksXG5cdH0pO1xuXG5cdGlmIChscy5sZW5ndGgpXG5cdHtcblx0XHROT1RfRE9ORSA9IHRydWU7XG5cdFx0Y29uc29sZS53YXJuKGDkuIrmrKHnmoTku7vli5nmnKrlrozmiJAg5pys5qyh57m857qM5Z+36KGMICgyKWApO1xuXG5cdFx0Y29uc29sZS5sb2cobHMpO1xuXG5cdFx0ZnMub3V0cHV0SlNPTlN5bmMocGF0aC5qb2luKFByb2plY3RDb25maWcuY2FjaGVfcm9vdCwgJ2RpZmYtbm92ZWwuanNvbicpLCBbXSwge1xuXHRcdFx0c3BhY2VzOiAnXFx0Jyxcblx0XHR9KTtcblx0fVxufVxuXG5leHBvcnQgY29uc3QgQlJfTkFNRSA9ICdhdXRvLycgKyBtb21lbnQoKS5mb3JtYXQoJ1lZWVktTU0tREQtSEgtbW0tc3MnKTtcblxuZXhwb3J0IGNvbnN0IE5PX1BVU0ggPSBNeUNvbmZpZyAmJiBNeUNvbmZpZy5jb25maWcuZGVidWcgJiYgTXlDb25maWcuY29uZmlnLmRlYnVnLm5vX3B1c2g7XG4iXX0=