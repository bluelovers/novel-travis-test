"use strict";
/**
 * Created by user on 2018/5/28/028.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const gitee_api_token_1 = require("gitee-api-token");
const client_oauth2_request_1 = require("client-oauth2-request");
const git_1 = require("../git");
const project_config_1 = require("../../project.config");
const dotenv_1 = require("dotenv");
const path = require("upath2");
const log_1 = require("../../lib/log");
async function createPullRequestsGitee() {
    log_1.default.info(`嘗試建立 PR`);
    let GITEE_ACCESS_TOKEN = process.env.GITEE_ACCESS_TOKEN || '';
    let GITEE_CLIENT_ID = process.env.GITEE_CLIENT_ID || '';
    let GITEE_CLIENT_SECRET = process.env.GITEE_CLIENT_SECRET || '';
    let GITEE_TOKEN1 = process.env.GITEE_TOKEN1 || '';
    let GITEE_TOKEN2 = process.env.GITEE_TOKEN2 || '';
    if (!GITEE_ACCESS_TOKEN || !GITEE_CLIENT_ID || !GITEE_CLIENT_SECRET) {
        let env = dotenv_1.config({ path: path.join(project_config_1.default.project_root, '.env') });
        if (env.parsed) {
            GITEE_ACCESS_TOKEN = GITEE_ACCESS_TOKEN || env.parsed.GITEE_ACCESS_TOKEN;
            GITEE_CLIENT_ID = GITEE_CLIENT_ID || env.parsed.GITEE_CLIENT_ID;
            GITEE_CLIENT_SECRET = GITEE_CLIENT_SECRET || env.parsed.GITEE_CLIENT_SECRET;
            GITEE_TOKEN1 = GITEE_TOKEN1 || env.parsed.GITEE_TOKEN1;
            GITEE_TOKEN2 = GITEE_TOKEN2 || env.parsed.GITEE_TOKEN2;
        }
    }
    let token = await gitee_api_token_1.default({
        //access_token: GITEE_ACCESS_TOKEN,
        username: GITEE_TOKEN1,
        password: GITEE_TOKEN2,
        clientId: GITEE_CLIENT_ID,
        clientSecret: GITEE_CLIENT_SECRET,
        scopes: 'pull_requests',
    }).catch(function (err) {
        log_1.default.error(err);
    });
    if (!token) {
        log_1.default.error(`無法取得 token`);
        return;
    }
    else {
        log_1.default.info(`已取得 token`);
    }
    let rq = new client_oauth2_request_1.default(token, {
        apiRoot: 'https://gitee.com/api/'
    });
    let br_name = git_1.currentBranchName(project_config_1.novel_root);
    if (!br_name.match(/^auto\//)) {
        log_1.default.error(`目前分支為 ${br_name} 忽略建立 PR`);
        return;
    }
    else {
        log_1.default.info(`目前分支為 ${br_name}`);
    }
    await rq
        .fetchSign('/v5/repos/bluelovers/novel/pulls', {
        method: 'POST',
        body: {
            title: br_name,
            head: `demogitee:${br_name}`,
            base: 'master',
            body: 'auto pr',
        },
    })
        .tap(function (ret) {
        log_1.default.success(`成功建立 PR #${ret.number} ${ret.title}`);
        //console.dir(ret);
    })
        .catch(function (err) {
        log_1.default.error(err.toString());
        log_1.default.error(err.code, err.status, err.body);
    });
}
exports.createPullRequestsGitee = createPullRequestsGitee;
exports.default = createPullRequestsGitee;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0ZWUtcHIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnaXRlZS1wci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgscURBQXVDO0FBQ3ZDLGlFQUFrRDtBQUNsRCxnQ0FBMkM7QUFDM0MseURBQWlFO0FBQ2pFLG1DQUFnRDtBQUNoRCwrQkFBZ0M7QUFDaEMsdUNBQW9DO0FBRTdCLEtBQUssVUFBVSx1QkFBdUI7SUFFNUMsYUFBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUV4QixJQUFJLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0lBQzlELElBQUksZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQztJQUN4RCxJQUFJLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksRUFBRSxDQUFDO0lBQ2hFLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQztJQUNsRCxJQUFJLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7SUFFbEQsSUFBSSxDQUFDLGtCQUFrQixJQUFJLENBQUMsZUFBZSxJQUFJLENBQUMsbUJBQW1CLEVBQ25FO1FBQ0MsSUFBSSxHQUFHLEdBQUcsZUFBWSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQWEsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWhGLElBQUksR0FBRyxDQUFDLE1BQU0sRUFDZDtZQUNDLGtCQUFrQixHQUFHLGtCQUFrQixJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUM7WUFDekUsZUFBZSxHQUFHLGVBQWUsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQztZQUNoRSxtQkFBbUIsR0FBRyxtQkFBbUIsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDO1lBRTVFLFlBQVksR0FBRyxZQUFZLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDdkQsWUFBWSxHQUFHLFlBQVksSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztTQUN2RDtLQUNEO0lBRUQsSUFBSSxLQUFLLEdBQUcsTUFBTSx5QkFBUSxDQUFDO1FBRTFCLG1DQUFtQztRQUVuQyxRQUFRLEVBQUUsWUFBWTtRQUN0QixRQUFRLEVBQUUsWUFBWTtRQUV0QixRQUFRLEVBQUUsZUFBZTtRQUN6QixZQUFZLEVBQUUsbUJBQW1CO1FBRWpDLE1BQU0sRUFBRSxlQUFlO0tBRXZCLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHO1FBRXJCLGFBQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsS0FBSyxFQUNWO1FBQ0MsYUFBTyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUU1QixPQUFPO0tBQ1A7U0FFRDtRQUNDLGFBQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7S0FDMUI7SUFFRCxJQUFJLEVBQUUsR0FBRyxJQUFJLCtCQUFhLENBQUMsS0FBSyxFQUFFO1FBQ2pDLE9BQU8sRUFBRSx3QkFBd0I7S0FDakMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxPQUFPLEdBQUcsdUJBQWlCLENBQUMsMkJBQVUsQ0FBQyxDQUFDO0lBRTVDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUM3QjtRQUNDLGFBQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxPQUFPLFVBQVUsQ0FBQyxDQUFDO1FBRTFDLE9BQU87S0FDUDtTQUVEO1FBQ0MsYUFBTyxDQUFDLElBQUksQ0FBQyxTQUFTLE9BQU8sRUFBRSxDQUFDLENBQUM7S0FDakM7SUFFRCxNQUFNLEVBQUU7U0FDTixTQUFTLENBQUMsa0NBQWtDLEVBQUU7UUFDOUMsTUFBTSxFQUFFLE1BQU07UUFDZCxJQUFJLEVBQUU7WUFDTCxLQUFLLEVBQUUsT0FBTztZQUNkLElBQUksRUFBRSxhQUFhLE9BQU8sRUFBRTtZQUM1QixJQUFJLEVBQUUsUUFBUTtZQUNkLElBQUksRUFBRSxTQUFTO1NBQ2Y7S0FDRCxDQUFDO1NBQ0QsR0FBRyxDQUFDLFVBQVUsR0FHZDtRQUVBLGFBQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxHQUFHLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZELG1CQUFtQjtJQUNwQixDQUFDLENBQUM7U0FDRCxLQUFLLENBQUMsVUFBVSxHQUFHO1FBRW5CLGFBQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDOUIsYUFBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQyxDQUNGO0FBQ0YsQ0FBQztBQTlGRCwwREE4RkM7QUFFRCxrQkFBZSx1QkFBdUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvNS8yOC8wMjguXG4gKi9cblxuaW1wb3J0IGdldFRva2VuIGZyb20gJ2dpdGVlLWFwaS10b2tlbic7XG5pbXBvcnQgQ2xpZW50UmVxdWVzdCBmcm9tICdjbGllbnQtb2F1dGgyLXJlcXVlc3QnO1xuaW1wb3J0IHsgY3VycmVudEJyYW5jaE5hbWUgfSBmcm9tICcuLi9naXQnO1xuaW1wb3J0IFByb2plY3RDb25maWcsIHsgbm92ZWxfcm9vdCB9IGZyb20gJy4uLy4uL3Byb2plY3QuY29uZmlnJztcbmltcG9ydCB7IGNvbmZpZyBhcyBkb3RlbnZDb25maWcgfSBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCd1cGF0aDInKTtcbmltcG9ydCBjb25zb2xlIGZyb20gJy4uLy4uL2xpYi9sb2cnO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlUHVsbFJlcXVlc3RzR2l0ZWUoKVxue1xuXHRjb25zb2xlLmluZm8oYOWYl+ippuW7uueriyBQUmApO1xuXG5cdGxldCBHSVRFRV9BQ0NFU1NfVE9LRU4gPSBwcm9jZXNzLmVudi5HSVRFRV9BQ0NFU1NfVE9LRU4gfHwgJyc7XG5cdGxldCBHSVRFRV9DTElFTlRfSUQgPSBwcm9jZXNzLmVudi5HSVRFRV9DTElFTlRfSUQgfHwgJyc7XG5cdGxldCBHSVRFRV9DTElFTlRfU0VDUkVUID0gcHJvY2Vzcy5lbnYuR0lURUVfQ0xJRU5UX1NFQ1JFVCB8fCAnJztcblx0bGV0IEdJVEVFX1RPS0VOMSA9IHByb2Nlc3MuZW52LkdJVEVFX1RPS0VOMSB8fCAnJztcblx0bGV0IEdJVEVFX1RPS0VOMiA9IHByb2Nlc3MuZW52LkdJVEVFX1RPS0VOMiB8fCAnJztcblxuXHRpZiAoIUdJVEVFX0FDQ0VTU19UT0tFTiB8fCAhR0lURUVfQ0xJRU5UX0lEIHx8ICFHSVRFRV9DTElFTlRfU0VDUkVUKVxuXHR7XG5cdFx0bGV0IGVudiA9IGRvdGVudkNvbmZpZyh7IHBhdGg6IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLnByb2plY3Rfcm9vdCwgJy5lbnYnKSB9KTtcblxuXHRcdGlmIChlbnYucGFyc2VkKVxuXHRcdHtcblx0XHRcdEdJVEVFX0FDQ0VTU19UT0tFTiA9IEdJVEVFX0FDQ0VTU19UT0tFTiB8fCBlbnYucGFyc2VkLkdJVEVFX0FDQ0VTU19UT0tFTjtcblx0XHRcdEdJVEVFX0NMSUVOVF9JRCA9IEdJVEVFX0NMSUVOVF9JRCB8fCBlbnYucGFyc2VkLkdJVEVFX0NMSUVOVF9JRDtcblx0XHRcdEdJVEVFX0NMSUVOVF9TRUNSRVQgPSBHSVRFRV9DTElFTlRfU0VDUkVUIHx8IGVudi5wYXJzZWQuR0lURUVfQ0xJRU5UX1NFQ1JFVDtcblxuXHRcdFx0R0lURUVfVE9LRU4xID0gR0lURUVfVE9LRU4xIHx8IGVudi5wYXJzZWQuR0lURUVfVE9LRU4xO1xuXHRcdFx0R0lURUVfVE9LRU4yID0gR0lURUVfVE9LRU4yIHx8IGVudi5wYXJzZWQuR0lURUVfVE9LRU4yO1xuXHRcdH1cblx0fVxuXG5cdGxldCB0b2tlbiA9IGF3YWl0IGdldFRva2VuKHtcblxuXHRcdC8vYWNjZXNzX3Rva2VuOiBHSVRFRV9BQ0NFU1NfVE9LRU4sXG5cblx0XHR1c2VybmFtZTogR0lURUVfVE9LRU4xLFxuXHRcdHBhc3N3b3JkOiBHSVRFRV9UT0tFTjIsXG5cblx0XHRjbGllbnRJZDogR0lURUVfQ0xJRU5UX0lELFxuXHRcdGNsaWVudFNlY3JldDogR0lURUVfQ0xJRU5UX1NFQ1JFVCxcblxuXHRcdHNjb3BlczogJ3B1bGxfcmVxdWVzdHMnLFxuXG5cdH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpXG5cdHtcblx0XHRjb25zb2xlLmVycm9yKGVycik7XG5cdH0pO1xuXG5cdGlmICghdG9rZW4pXG5cdHtcblx0XHRjb25zb2xlLmVycm9yKGDnhKHms5Xlj5blvpcgdG9rZW5gKTtcblxuXHRcdHJldHVybjtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRjb25zb2xlLmluZm8oYOW3suWPluW+lyB0b2tlbmApO1xuXHR9XG5cblx0bGV0IHJxID0gbmV3IENsaWVudFJlcXVlc3QodG9rZW4sIHtcblx0XHRhcGlSb290OiAnaHR0cHM6Ly9naXRlZS5jb20vYXBpLydcblx0fSk7XG5cblx0bGV0IGJyX25hbWUgPSBjdXJyZW50QnJhbmNoTmFtZShub3ZlbF9yb290KTtcblxuXHRpZiAoIWJyX25hbWUubWF0Y2goL15hdXRvXFwvLykpXG5cdHtcblx0XHRjb25zb2xlLmVycm9yKGDnm67liY3liIbmlK/ngrogJHticl9uYW1lfSDlv73nlaXlu7rnq4sgUFJgKTtcblxuXHRcdHJldHVybjtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRjb25zb2xlLmluZm8oYOebruWJjeWIhuaUr+eCuiAke2JyX25hbWV9YCk7XG5cdH1cblxuXHRhd2FpdCBycVxuXHRcdC5mZXRjaFNpZ24oJy92NS9yZXBvcy9ibHVlbG92ZXJzL25vdmVsL3B1bGxzJywge1xuXHRcdFx0bWV0aG9kOiAnUE9TVCcsXG5cdFx0XHRib2R5OiB7XG5cdFx0XHRcdHRpdGxlOiBicl9uYW1lLFxuXHRcdFx0XHRoZWFkOiBgZGVtb2dpdGVlOiR7YnJfbmFtZX1gLFxuXHRcdFx0XHRiYXNlOiAnbWFzdGVyJyxcblx0XHRcdFx0Ym9keTogJ2F1dG8gcHInLFxuXHRcdFx0fSxcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKHJldDoge1xuXHRcdFx0bnVtYmVyOiBudW1iZXIsXG5cdFx0XHR0aXRsZTogc3RyaW5nLFxuXHRcdH0pXG5cdFx0e1xuXHRcdFx0Y29uc29sZS5zdWNjZXNzKGDmiJDlip/lu7rnq4sgUFIgIyR7cmV0Lm51bWJlcn0gJHtyZXQudGl0bGV9YCk7XG5cdFx0XHQvL2NvbnNvbGUuZGlyKHJldCk7XG5cdFx0fSlcblx0XHQuY2F0Y2goZnVuY3Rpb24gKGVycilcblx0XHR7XG5cdFx0XHRjb25zb2xlLmVycm9yKGVyci50b1N0cmluZygpKTtcblx0XHRcdGNvbnNvbGUuZXJyb3IoZXJyLmNvZGUsIGVyci5zdGF0dXMsIGVyci5ib2R5KTtcblx0XHR9KVxuXHQ7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZVB1bGxSZXF1ZXN0c0dpdGVlO1xuIl19