"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs-extra");
const project_config_1 = require("../project.config");
const path = require("upath2");
const index_1 = require("@node-novel/task/lib/index");
const array_hyper_unique_1 = require("array-hyper-unique");
const log_1 = require("../lib/log");
async function cacheDiffNovelList(data) {
    let jsonfile = path.join(project_config_1.default.cache_root, 'diff-novel.json');
    let ls = [];
    if (0 && fs.existsSync(jsonfile)) {
        ls = await fs.readJSON(jsonfile);
    }
    Object.keys(data.list)
        .forEach(function (pathMain) {
        if (pathMain.match(/^\./) || ['docs'].includes(pathMain)) {
            log_1.default.grey('[SKIP (cacheDiffNovelList)]', pathMain, Object.keys(data.list[pathMain]));
            return;
        }
        Object.keys(data.list[pathMain]).forEach(function (novelID) {
            let arr = data.list[pathMain][novelID].filter(function (v) {
                return _filterFile(v.basename || path.basename(v.fullpath));
            });
            if (arr.length) {
                log_1.default.ok('[CACHE (cacheDiffNovelList)]', pathMain, novelID, data.list[pathMain][novelID].length, arr.length);
                ls.push({ pathMain, novelID });
            }
            else {
                log_1.default.gray('[SKIP (cacheDiffNovelList)]', pathMain, novelID, data.list[pathMain][novelID].length);
            }
            //console.log(data.list[pathMain][novelID]);
        });
    });
    ls = array_hyper_unique_1.array_unique(ls.filter(v => v));
    fs.outputJSONSync(jsonfile, ls, {
        spaces: '\t',
    });
    return ls;
}
exports.cacheDiffNovelList = cacheDiffNovelList;
async function cacheFileList(data) {
    if (data.pathMain.match(/_out$|^\./) || ['docs'].includes(data.pathMain)) {
        log_1.default.grey('[CACHE (cacheFileList)]', 'SKIP: ', data.pathMain, data.novelID);
        return;
    }
    let dir = path.join(project_config_1.default.cache_root, 'files', data.pathMain);
    let file = path.join(dir, data.novelID + '.json');
    await fs.ensureDir(dir);
    let ls = [];
    if (fs.existsSync(file)) {
        ls = await fs.readJSON(file);
    }
    ls = ls
        .concat(index_1.filterNotDelete(data).map(function (b) {
        return b.subpath;
    }))
        .filter(function (v) {
        return _filterFile(v);
    });
    ls = array_hyper_unique_1.array_unique(ls);
    // 防止除了 txt 與 readme 以外的檔案觸發更新
    if (ls.length > 0) {
        log_1.default.ok('[CACHE (cacheFileList)]', path.join(data.pathMain, data.novelID + '.json'), ls.length);
        await fs.outputJSON(file, ls, {
            spaces: '\t',
        });
    }
    else {
        log_1.default.red('[CACHE (cacheFileList)]', 'SKIP2: ', data.pathMain, data.novelID);
    }
    return ls;
}
exports.cacheFileList = cacheFileList;
function _filterFile(file) {
    let basename = path.basename(file);
    let ext = path.extname(basename);
    if (ext == '.md' && /readme/i.test(basename)) {
        return true;
    }
    return ext == '.txt';
}
exports._filterFile = _filterFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUcvQixzREFBOEM7QUFDOUMsK0JBQWdDO0FBQ2hDLHNEQUE2RDtBQUM3RCwyREFBK0Q7QUFJL0Qsb0NBQWlDO0FBRTFCLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxJQUF5QztJQUVqRixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFFdEUsSUFBSSxFQUFFLEdBQTRDLEVBQUUsQ0FBQztJQUVyRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUNoQztRQUNDLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDakM7SUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDcEIsT0FBTyxDQUFDLFVBQVUsUUFBUTtRQUUxQixJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQ3hEO1lBQ0MsYUFBTyxDQUFDLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4RixPQUFPO1NBQ1A7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxPQUFPO1lBR3pELElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FB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LENBQUMsTUFBTSxDQUFDLENBQUM7UUFFbkcsTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDN0IsTUFBTSxFQUFFLElBQUk7U0FDWixDQUFDLENBQUM7S0FDSDtTQUVEO1FBQ0MsYUFBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDL0U7SUFFRCxPQUFPLEVBQUUsQ0FBQztBQUNYLENBQUM7QUFoREQsc0NBZ0RDO0FBRUQsU0FBZ0IsV0FBVyxDQUFDLElBQVk7SUFFdkMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRWpDLElBQUksR0FBRyxJQUFJLEtBQUssSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUM1QztRQUNDLE9BQU8sSUFBSSxDQUFDO0tBQ1o7SUFFRCxPQUFPLEdBQUcsSUFBSSxNQUFNLENBQUM7QUFDdEIsQ0FBQztBQVhELGtDQVdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IG5vdmVsRGlmZkZyb21Mb2cgZnJvbSAnQG5vZGUtbm92ZWwvdGFzayc7XG5pbXBvcnQgeyBJTGlzdE5vdmVsUm93IH0gZnJvbSAnQG5vZGUtbm92ZWwvdGFzayc7XG5pbXBvcnQgUHJvamVjdENvbmZpZyBmcm9tICcuLi9wcm9qZWN0LmNvbmZpZyc7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuaW1wb3J0IHsgZmlsdGVyTm90RGVsZXRlIH0gZnJvbSAnQG5vZGUtbm92ZWwvdGFzay9saWIvaW5kZXgnO1xuaW1wb3J0IHsgYXJyYXlfdW5pcXVlIGFzIGFycmF5VW5pcSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5pbXBvcnQgeyBfcGF0aCB9IGZyb20gJy4uL3NjcmlwdC9zZWdtZW50JztcbmltcG9ydCAqIGFzIFByb21pc2VCbHVlYmlyZCBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgKiBhcyBGYXN0R2xvYiBmcm9tICdmYXN0LWdsb2InO1xuaW1wb3J0IGNvbnNvbGUgZnJvbSAnLi4vbGliL2xvZyc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWNoZURpZmZOb3ZlbExpc3QoZGF0YTogUmV0dXJuVHlwZTx0eXBlb2Ygbm92ZWxEaWZmRnJvbUxvZz4pXG57XG5cdGxldCBqc29uZmlsZSA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLmNhY2hlX3Jvb3QsICdkaWZmLW5vdmVsLmpzb24nKTtcblxuXHRsZXQgbHM6IHsgcGF0aE1haW46IHN0cmluZywgbm92ZWxJRDogc3RyaW5nIH1bXSA9IFtdO1xuXG5cdGlmICgwICYmIGZzLmV4aXN0c1N5bmMoanNvbmZpbGUpKVxuXHR7XG5cdFx0bHMgPSBhd2FpdCBmcy5yZWFkSlNPTihqc29uZmlsZSk7XG5cdH1cblxuXHRPYmplY3Qua2V5cyhkYXRhLmxpc3QpXG5cdFx0LmZvckVhY2goZnVuY3Rpb24gKHBhdGhNYWluKVxuXHRcdHtcblx0XHRcdGlmIChwYXRoTWFpbi5tYXRjaCgvXlxcLi8pIHx8IFsnZG9jcyddLmluY2x1ZGVzKHBhdGhNYWluKSlcblx0XHRcdHtcblx0XHRcdFx0Y29uc29sZS5ncmV5KCdbU0tJUCAoY2FjaGVEaWZmTm92ZWxMaXN0KV0nLCBwYXRoTWFpbiwgT2JqZWN0LmtleXMoZGF0YS5saXN0W3BhdGhNYWluXSkpO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdE9iamVjdC5rZXlzKGRhdGEubGlzdFtwYXRoTWFpbl0pLmZvckVhY2goZnVuY3Rpb24gKG5vdmVsSUQpXG5cdFx0XHR7XG5cblx0XHRcdFx0bGV0IGFyciA9IGRhdGEubGlzdFtwYXRoTWFpbl1bbm92ZWxJRF0uZmlsdGVyKGZ1bmN0aW9uICh2KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIF9maWx0ZXJGaWxlKHYuYmFzZW5hbWUgfHwgcGF0aC5iYXNlbmFtZSh2LmZ1bGxwYXRoKSk7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdGlmIChhcnIubGVuZ3RoKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29uc29sZS5vaygnW0NBQ0hFIChjYWNoZURpZmZOb3ZlbExpc3QpXScsIHBhdGhNYWluLCBub3ZlbElELCBkYXRhLmxpc3RbcGF0aE1haW5dW25vdmVsSURdLmxlbmd0aCwgYXJyLmxlbmd0aCk7XG5cdFx0XHRcdFx0bHMucHVzaCh7IHBhdGhNYWluLCBub3ZlbElEIH0pXG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29uc29sZS5ncmF5KCdbU0tJUCAoY2FjaGVEaWZmTm92ZWxMaXN0KV0nLCBwYXRoTWFpbiwgbm92ZWxJRCwgZGF0YS5saXN0W3BhdGhNYWluXVtub3ZlbElEXS5sZW5ndGgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly9jb25zb2xlLmxvZyhkYXRhLmxpc3RbcGF0aE1haW5dW25vdmVsSURdKTtcblx0XHRcdH0pXG5cdFx0fSlcblx0O1xuXG5cdGxzID0gYXJyYXlVbmlxKGxzLmZpbHRlcih2ID0+IHYpKTtcblxuXHRmcy5vdXRwdXRKU09OU3luYyhqc29uZmlsZSwgbHMsIHtcblx0XHRzcGFjZXM6ICdcXHQnLFxuXHR9KTtcblxuXHRyZXR1cm4gbHM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWNoZUZpbGVMaXN0KGRhdGE6IElMaXN0Tm92ZWxSb3cpXG57XG5cdGlmIChkYXRhLnBhdGhNYWluLm1hdGNoKC9fb3V0JHxeXFwuLykgfHwgWydkb2NzJ10uaW5jbHVkZXMoZGF0YS5wYXRoTWFpbikpXG5cdHtcblx0XHRjb25zb2xlLmdyZXkoJ1tDQUNIRSAoY2FjaGVGaWxlTGlzdCldJywgJ1NLSVA6ICcsIGRhdGEucGF0aE1haW4sIGRhdGEubm92ZWxJRCk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0bGV0IGRpciA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLmNhY2hlX3Jvb3QsICdmaWxlcycsIGRhdGEucGF0aE1haW4pO1xuXHRsZXQgZmlsZSA9IHBhdGguam9pbihkaXIsIGRhdGEubm92ZWxJRCArICcuanNvbicpO1xuXG5cdGF3YWl0IGZzLmVuc3VyZURpcihkaXIpO1xuXG5cdGxldCBscyA9IFtdIGFzIHN0cmluZ1tdO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKGZpbGUpKVxuXHR7XG5cdFx0bHMgPSBhd2FpdCBmcy5yZWFkSlNPTihmaWxlKTtcblx0fVxuXG5cdGxzID0gbHNcblx0XHQuY29uY2F0KGZpbHRlck5vdERlbGV0ZShkYXRhKS5tYXAoZnVuY3Rpb24gKGIpXG5cdHtcblx0XHRyZXR1cm4gYi5zdWJwYXRoO1xuXHR9KSlcblx0XHQuZmlsdGVyKGZ1bmN0aW9uICh2KVxuXHRcdHtcblx0XHRcdHJldHVybiBfZmlsdGVyRmlsZSh2KTtcblx0XHR9KVxuXHQ7XG5cblx0bHMgPSBhcnJheVVuaXEobHMpO1xuXG5cdC8vIOmYsuatoumZpOS6hiB0eHQg6IiHIHJlYWRtZSDku6XlpJbnmoTmqpTmoYjop7jnmbzmm7TmlrBcblx0aWYgKGxzLmxlbmd0aCA+IDApXG5cdHtcblx0XHRjb25zb2xlLm9rKCdbQ0FDSEUgKGNhY2hlRmlsZUxpc3QpXScsIHBhdGguam9pbihkYXRhLnBhdGhNYWluLCBkYXRhLm5vdmVsSUQgKyAnLmpzb24nKSwgbHMubGVuZ3RoKTtcblxuXHRcdGF3YWl0IGZzLm91dHB1dEpTT04oZmlsZSwgbHMsIHtcblx0XHRcdHNwYWNlczogJ1xcdCcsXG5cdFx0fSk7XG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0Y29uc29sZS5yZWQoJ1tDQUNIRSAoY2FjaGVGaWxlTGlzdCldJywgJ1NLSVAyOiAnLCBkYXRhLnBhdGhNYWluLCBkYXRhLm5vdmVsSUQpO1xuXHR9XG5cblx0cmV0dXJuIGxzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2ZpbHRlckZpbGUoZmlsZTogc3RyaW5nKVxue1xuXHRsZXQgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUpO1xuXHRsZXQgZXh0ID0gcGF0aC5leHRuYW1lKGJhc2VuYW1lKTtcblxuXHRpZiAoZXh0ID09ICcubWQnICYmIC9yZWFkbWUvaS50ZXN0KGJhc2VuYW1lKSlcblx0e1xuXHRcdHJldHVybiB0cnVlO1xuXHR9XG5cblx0cmV0dXJuIGV4dCA9PSAnLnR4dCc7XG59XG4iXX0=