"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs-extra");
const project_config_1 = require("../project.config");
const path = require("upath2");
const index_1 = require("@node-novel/task/lib/index");
const array_hyper_unique_1 = require("array-hyper-unique");
const log_1 = require("../lib/log");
async function cacheDiffNovelList(data) {
    let jsonfile = path.join(project_config_1.default.cache_root, 'diff-novel.json');
    let ls = [];
    if (0 && fs.existsSync(jsonfile)) {
        ls = await fs.readJSON(jsonfile);
    }
    Object.keys(data.list)
        .forEach(function (pathMain) {
        if (pathMain.match(/^\./) || ['docs'].includes(pathMain)) {
            log_1.default.grey('[SKIP (cacheDiffNovelList)]', pathMain, Object.keys(data.list[pathMain]));
            return;
        }
        Object.keys(data.list[pathMain]).forEach(function (novelID) {
            if (!fs.pathExistsSync(path.join(project_config_1.default.novel_root, pathMain, novelID, 'README.md'))) {
                log_1.default.red('[CACHE (cacheDiffNovelList)]', 'WARN: ', pathMain, novelID, `README.md 不存在`);
                return;
            }
            let arr = data.list[pathMain][novelID].filter(function (v) {
                return _filterFile(v.basename || path.basename(v.fullpath));
            });
            if (arr.length) {
                log_1.default.ok('[CACHE (cacheDiffNovelList)]', pathMain, novelID, data.list[pathMain][novelID].length, arr.length);
                ls.push({ pathMain, novelID });
            }
            else {
                log_1.default.gray('[SKIP (cacheDiffNovelList)]', pathMain, novelID, data.list[pathMain][novelID].length);
            }
            //console.log(data.list[pathMain][novelID]);
        });
    });
    ls = array_hyper_unique_1.array_unique(ls.filter(v => v));
    fs.outputJSONSync(jsonfile, ls, {
        spaces: '\t',
    });
    return ls;
}
exports.cacheDiffNovelList = cacheDiffNovelList;
async function cacheFileList(data) {
    let dir = path.join(project_config_1.default.cache_root, 'files', data.pathMain);
    let file = path.join(dir, data.novelID + '.json');
    if (!fs.pathExistsSync(path.join(project_config_1.default.novel_root, data.pathMain, data.novelID, 'README.md'))) {
        log_1.default.red('[CACHE (cacheFileList)]', 'WARN: ', data.pathMain, data.novelID, `README.md 不存在`);
        await fs.removeSync(file);
        return;
    }
    else if (data.pathMain.match(/_out$|^\./) || ['docs'].includes(data.pathMain)) {
        log_1.default.grey('[CACHE (cacheFileList)]', 'SKIP: ', data.pathMain, data.novelID);
        return;
    }
    await fs.ensureDir(dir);
    let ls = [];
    if (fs.existsSync(file)) {
        ls = await fs.readJSON(file);
    }
    ls = ls
        .concat(index_1.filterNotDelete(data).map(function (b) {
        return b.subpath;
    }))
        .filter(function (v) {
        return _filterFile(v);
    });
    ls = array_hyper_unique_1.array_unique(ls);
    // 防止除了 txt 與 readme 以外的檔案觸發更新
    if (ls.length > 0) {
        log_1.default.ok('[CACHE (cacheFileList)]', path.join(data.pathMain, data.novelID + '.json'), ls.length);
        await fs.outputJSON(file, ls, {
            spaces: '\t',
        });
    }
    else {
        log_1.default.red('[CACHE (cacheFileList)]', 'SKIP2: ', data.pathMain, data.novelID);
    }
    return ls;
}
exports.cacheFileList = cacheFileList;
function _filterFile(file) {
    let basename = path.basename(file);
    let ext = path.extname(basename);
    if (ext == '.md' && /readme/i.test(basename)) {
        return true;
    }
    return ext == '.txt';
}
exports._filterFile = _filterFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUcvQixzREFBOEM7QUFDOUMsK0JBQWdDO0FBQ2hDLHNEQUE2RDtBQUM3RCwyREFBK0Q7QUFJL0Qsb0NBQWlDO0FBRTFCLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxJQUF5QztJQUVqRixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFFdEUsSUFBSSxFQUFFLEdBQTRDLEVBQUUsQ0FBQztJQUVyRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUNoQztRQUNDLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDakM7SUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDcEIsT0FBTyxDQUFDLFVBQVUsUUFBUTtRQUUxQixJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQ3hEO1lBQ0MsYUFBTyxDQUFDLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4RixPQUFPO1NBQ1A7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxPQUFPO1lBRXpELElBQUksQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQWEsQ0FBQyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9B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UUFBUSxDQUFDLENBQUM7SUFFakMsSUFBSSxHQUFHLElBQUksS0FBSyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQzVDO1FBQ0MsT0FBTyxJQUFJLENBQUM7S0FDWjtJQUVELE9BQU8sR0FBRyxJQUFJLE1BQU0sQ0FBQztBQUN0QixDQUFDO0FBWEQsa0NBV0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgbm92ZWxEaWZmRnJvbUxvZyBmcm9tICdAbm9kZS1ub3ZlbC90YXNrJztcbmltcG9ydCB7IElMaXN0Tm92ZWxSb3cgfSBmcm9tICdAbm9kZS1ub3ZlbC90YXNrJztcbmltcG9ydCBQcm9qZWN0Q29uZmlnIGZyb20gJy4uL3Byb2plY3QuY29uZmlnJztcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgndXBhdGgyJyk7XG5pbXBvcnQgeyBmaWx0ZXJOb3REZWxldGUgfSBmcm9tICdAbm9kZS1ub3ZlbC90YXNrL2xpYi9pbmRleCc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUgYXMgYXJyYXlVbmlxIH0gZnJvbSAnYXJyYXktaHlwZXItdW5pcXVlJztcbmltcG9ydCB7IF9wYXRoIH0gZnJvbSAnLi4vc2NyaXB0L3NlZ21lbnQnO1xuaW1wb3J0ICogYXMgUHJvbWlzZUJsdWViaXJkIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCAqIGFzIEZhc3RHbG9iIGZyb20gJ2Zhc3QtZ2xvYic7XG5pbXBvcnQgY29uc29sZSBmcm9tICcuLi9saWIvbG9nJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhY2hlRGlmZk5vdmVsTGlzdChkYXRhOiBSZXR1cm5UeXBlPHR5cGVvZiBub3ZlbERpZmZGcm9tTG9nPilcbntcblx0bGV0IGpzb25maWxlID0gcGF0aC5qb2luKFByb2plY3RDb25maWcuY2FjaGVfcm9vdCwgJ2RpZmYtbm92ZWwuanNvbicpO1xuXG5cdGxldCBsczogeyBwYXRoTWFpbjogc3RyaW5nLCBub3ZlbElEOiBzdHJpbmcgfVtdID0gW107XG5cblx0aWYgKDAgJiYgZnMuZXhpc3RzU3luYyhqc29uZmlsZSkpXG5cdHtcblx0XHRscyA9IGF3YWl0IGZzLnJlYWRKU09OKGpzb25maWxlKTtcblx0fVxuXG5cdE9iamVjdC5rZXlzKGRhdGEubGlzdClcblx0XHQuZm9yRWFjaChmdW5jdGlvbiAocGF0aE1haW4pXG5cdFx0e1xuXHRcdFx0aWYgKHBhdGhNYWluLm1hdGNoKC9eXFwuLykgfHwgWydkb2NzJ10uaW5jbHVkZXMocGF0aE1haW4pKVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zb2xlLmdyZXkoJ1tTS0lQIChjYWNoZURpZmZOb3ZlbExpc3QpXScsIHBhdGhNYWluLCBPYmplY3Qua2V5cyhkYXRhLmxpc3RbcGF0aE1haW5dKSk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0T2JqZWN0LmtleXMoZGF0YS5saXN0W3BhdGhNYWluXSkuZm9yRWFjaChmdW5jdGlvbiAobm92ZWxJRClcblx0XHRcdHtcblx0XHRcdFx0aWYgKCFmcy5wYXRoRXhpc3RzU3luYyhwYXRoLmpvaW4oUHJvamVjdENvbmZpZy5ub3ZlbF9yb290LCBwYXRoTWFpbiwgbm92ZWxJRCwgJ1JFQURNRS5tZCcpKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGNvbnNvbGUucmVkKCdbQ0FDSEUgKGNhY2hlRGlmZk5vdmVsTGlzdCldJywgJ1dBUk46ICcsIHBhdGhNYWluLCBub3ZlbElELCBgUkVBRE1FLm1kIOS4jeWtmOWcqGApO1xuXG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IGFyciA9IGRhdGEubGlzdFtwYXRoTWFpbl1bbm92ZWxJRF0uZmlsdGVyKGZ1bmN0aW9uICh2KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIF9maWx0ZXJGaWxlKHYuYmFzZW5hbWUgfHwgcGF0aC5iYXNlbmFtZSh2LmZ1bGxwYXRoKSk7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdGlmIChhcnIubGVuZ3RoKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29uc29sZS5vaygnW0NBQ0hFIChjYWNoZURpZmZOb3ZlbExpc3QpXScsIHBhdGhNYWluLCBub3ZlbElELCBkYXRhLmxpc3RbcGF0aE1haW5dW25vdmVsSURdLmxlbmd0aCwgYXJyLmxlbmd0aCk7XG5cdFx0XHRcdFx0bHMucHVzaCh7IHBhdGhNYWluLCBub3ZlbElEIH0pXG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29uc29sZS5ncmF5KCdbU0tJUCAoY2FjaGVEaWZmTm92ZWxMaXN0KV0nLCBwYXRoTWFpbiwgbm92ZWxJRCwgZGF0YS5saXN0W3BhdGhNYWluXVtub3ZlbElEXS5sZW5ndGgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly9jb25zb2xlLmxvZyhkYXRhLmxpc3RbcGF0aE1haW5dW25vdmVsSURdKTtcblx0XHRcdH0pXG5cdFx0fSlcblx0O1xuXG5cdGxzID0gYXJyYXlVbmlxKGxzLmZpbHRlcih2ID0+IHYpKTtcblxuXHRmcy5vdXRwdXRKU09OU3luYyhqc29uZmlsZSwgbHMsIHtcblx0XHRzcGFjZXM6ICdcXHQnLFxuXHR9KTtcblxuXHRyZXR1cm4gbHM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWNoZUZpbGVMaXN0KGRhdGE6IElMaXN0Tm92ZWxSb3cpXG57XG5cdGxldCBkaXIgPSBwYXRoLmpvaW4oUHJvamVjdENvbmZpZy5jYWNoZV9yb290LCAnZmlsZXMnLCBkYXRhLnBhdGhNYWluKTtcblx0bGV0IGZpbGUgPSBwYXRoLmpvaW4oZGlyLCBkYXRhLm5vdmVsSUQgKyAnLmpzb24nKTtcblxuXHRpZiAoIWZzLnBhdGhFeGlzdHNTeW5jKHBhdGguam9pbihQcm9qZWN0Q29uZmlnLm5vdmVsX3Jvb3QsIGRhdGEucGF0aE1haW4sIGRhdGEubm92ZWxJRCwgJ1JFQURNRS5tZCcpKSlcblx0e1xuXHRcdGNvbnNvbGUucmVkKCdbQ0FDSEUgKGNhY2hlRmlsZUxpc3QpXScsICdXQVJOOiAnLCBkYXRhLnBhdGhNYWluLCBkYXRhLm5vdmVsSUQsIGBSRUFETUUubWQg5LiN5a2Y5ZyoYCk7XG5cblx0XHRhd2FpdCBmcy5yZW1vdmVTeW5jKGZpbGUpO1xuXG5cdFx0cmV0dXJuO1xuXHR9XG5cdGVsc2UgaWYgKGRhdGEucGF0aE1haW4ubWF0Y2goL19vdXQkfF5cXC4vKSB8fCBbJ2RvY3MnXS5pbmNsdWRlcyhkYXRhLnBhdGhNYWluKSlcblx0e1xuXHRcdGNvbnNvbGUuZ3JleSgnW0NBQ0hFIChjYWNoZUZpbGVMaXN0KV0nLCAnU0tJUDogJywgZGF0YS5wYXRoTWFpbiwgZGF0YS5ub3ZlbElEKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRhd2FpdCBmcy5lbnN1cmVEaXIoZGlyKTtcblxuXHRsZXQgbHMgPSBbXSBhcyBzdHJpbmdbXTtcblxuXHRpZiAoZnMuZXhpc3RzU3luYyhmaWxlKSlcblx0e1xuXHRcdGxzID0gYXdhaXQgZnMucmVhZEpTT04oZmlsZSk7XG5cdH1cblxuXHRscyA9IGxzXG5cdFx0LmNvbmNhdChmaWx0ZXJOb3REZWxldGUoZGF0YSkubWFwKGZ1bmN0aW9uIChiKVxuXHR7XG5cdFx0cmV0dXJuIGIuc3VicGF0aDtcblx0fSkpXG5cdFx0LmZpbHRlcihmdW5jdGlvbiAodilcblx0XHR7XG5cdFx0XHRyZXR1cm4gX2ZpbHRlckZpbGUodik7XG5cdFx0fSlcblx0O1xuXG5cdGxzID0gYXJyYXlVbmlxKGxzKTtcblxuXHQvLyDpmLLmraLpmaTkuoYgdHh0IOiIhyByZWFkbWUg5Lul5aSW55qE5qqU5qGI6Ke455m85pu05pawXG5cdGlmIChscy5sZW5ndGggPiAwKVxuXHR7XG5cdFx0Y29uc29sZS5vaygnW0NBQ0hFIChjYWNoZUZpbGVMaXN0KV0nLCBwYXRoLmpvaW4oZGF0YS5wYXRoTWFpbiwgZGF0YS5ub3ZlbElEICsgJy5qc29uJyksIGxzLmxlbmd0aCk7XG5cblx0XHRhd2FpdCBmcy5vdXRwdXRKU09OKGZpbGUsIGxzLCB7XG5cdFx0XHRzcGFjZXM6ICdcXHQnLFxuXHRcdH0pO1xuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdGNvbnNvbGUucmVkKCdbQ0FDSEUgKGNhY2hlRmlsZUxpc3QpXScsICdTS0lQMjogJywgZGF0YS5wYXRoTWFpbiwgZGF0YS5ub3ZlbElEKTtcblx0fVxuXG5cdHJldHVybiBscztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9maWx0ZXJGaWxlKGZpbGU6IHN0cmluZylcbntcblx0bGV0IGJhc2VuYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlKTtcblx0bGV0IGV4dCA9IHBhdGguZXh0bmFtZShiYXNlbmFtZSk7XG5cblx0aWYgKGV4dCA9PSAnLm1kJyAmJiAvcmVhZG1lL2kudGVzdChiYXNlbmFtZSkpXG5cdHtcblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdHJldHVybiBleHQgPT0gJy50eHQnO1xufVxuIl19