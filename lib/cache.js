"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports._filterFile = exports.cacheFileList = exports.cacheDiffNovelList = void 0;
const fs = require("fs-extra");
const project_config_1 = require("../project.config");
const path = require("upath2");
const index_1 = require("@node-novel/task/lib/index");
const array_hyper_unique_1 = require("array-hyper-unique");
const log_1 = require("../lib/log");
async function cacheDiffNovelList(data) {
    let jsonfile = path.join(project_config_1.default.cache_root, 'diff-novel.json');
    let ls = [];
    if (0 && fs.existsSync(jsonfile)) {
        ls = await fs.readJSON(jsonfile);
    }
    Object.keys(data.list)
        .forEach(function (pathMain) {
        if (pathMain.match(/^\./) || ['docs'].includes(pathMain)) {
            log_1.default.grey('[SKIP (cacheDiffNovelList)]', pathMain, Object.keys(data.list[pathMain]));
            return;
        }
        Object.keys(data.list[pathMain]).forEach(function (novelID) {
            if (!fs.pathExistsSync(path.join(project_config_1.default.novel_root, pathMain, novelID, 'README.md'))) {
                log_1.default.red('[CACHE (cacheDiffNovelList)]', 'WARN: ', pathMain, novelID, `README.md 不存在`);
                return;
            }
            let arr = data.list[pathMain][novelID].filter(function (v) {
                return _filterFile(v.basename || path.basename(v.fullpath));
            });
            if (arr.length) {
                log_1.default.ok('[CACHE (cacheDiffNovelList)]', pathMain, novelID, data.list[pathMain][novelID].length, arr.length);
                ls.push({ pathMain, novelID });
            }
            else {
                log_1.default.gray('[SKIP (cacheDiffNovelList)]', pathMain, novelID, data.list[pathMain][novelID].length);
            }
            //console.log(data.list[pathMain][novelID]);
        });
    });
    ls = array_hyper_unique_1.array_unique(ls.filter(v => v));
    fs.outputJSONSync(jsonfile, ls, {
        spaces: '\t',
    });
    return ls;
}
exports.cacheDiffNovelList = cacheDiffNovelList;
async function cacheFileList(data) {
    let dir = path.join(project_config_1.default.cache_root, 'files', data.pathMain);
    let file = path.join(dir, data.novelID + '.json');
    if (!fs.pathExistsSync(path.join(project_config_1.default.novel_root, data.pathMain, data.novelID, 'README.md'))) {
        log_1.default.red('[CACHE (cacheFileList)]', 'WARN: ', data.pathMain, data.novelID, `README.md 不存在`);
        await fs.removeSync(file);
        return;
    }
    else if (data.pathMain.match(/_out$|^\./) || ['docs'].includes(data.pathMain)) {
        log_1.default.grey('[CACHE (cacheFileList)]', 'SKIP: ', data.pathMain, data.novelID);
        return;
    }
    await fs.ensureDir(dir);
    let ls = [];
    if (fs.existsSync(file)) {
        ls = await fs.readJSON(file);
    }
    ls = ls
        .concat(index_1.filterNotDelete(data).map(function (b) {
        return b.subpath;
    }))
        .filter(function (v) {
        return _filterFile(v);
    });
    ls = array_hyper_unique_1.array_unique(ls);
    // 防止除了 txt 與 readme 以外的檔案觸發更新
    if (ls.length > 0) {
        log_1.default.ok('[CACHE (cacheFileList)]', path.join(data.pathMain, data.novelID + '.json'), ls.length);
        await fs.outputJSON(file, ls, {
            spaces: '\t',
        });
    }
    else {
        log_1.default.red('[CACHE (cacheFileList)]', 'SKIP2: ', data.pathMain, data.novelID);
    }
    return ls;
}
exports.cacheFileList = cacheFileList;
function _filterFile(file) {
    let basename = path.basename(file);
    let ext = path.extname(basename);
    if (ext == '.md' && /readme/i.test(basename)) {
        return true;
    }
    return ext == '.txt';
}
exports._filterFile = _filterFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBK0I7QUFHL0Isc0RBQThDO0FBQzlDLCtCQUFnQztBQUNoQyxzREFBNkQ7QUFDN0QsMkRBQStEO0FBSS9ELG9DQUFpQztBQUUxQixLQUFLLFVBQVUsa0JBQWtCLENBQUMsSUFBeUM7SUFFakYsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBYSxDQUFDLFVBQVUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBRXRFLElBQUksRUFBRSxHQUE0QyxFQUFFLENBQUM7SUFFckQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFDaEM7UUFDQyxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ2pDO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3BCLE9BQU8sQ0FBQyxVQUFVLFFBQVE7UUFFMUIsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUN4RDtZQUNDLGFBQU8sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEYsT0FBTztTQUNQO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsT0FBTztZQUV6RCxJQUFJLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxP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LFFBQVEsQ0FBQyxDQUFDO0lBRWpDLElBQUksR0FBRyxJQUFJLEtBQUssSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUM1QztRQUNDLE9BQU8sSUFBSSxDQUFDO0tBQ1o7SUFFRCxPQUFPLEdBQUcsSUFBSSxNQUFNLENBQUM7QUFDdEIsQ0FBQztBQVhELGtDQVdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IG5vdmVsRGlmZkZyb21Mb2cgZnJvbSAnQG5vZGUtbm92ZWwvdGFzayc7XG5pbXBvcnQgeyBJTGlzdE5vdmVsUm93IH0gZnJvbSAnQG5vZGUtbm92ZWwvdGFzayc7XG5pbXBvcnQgUHJvamVjdENvbmZpZyBmcm9tICcuLi9wcm9qZWN0LmNvbmZpZyc7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuaW1wb3J0IHsgZmlsdGVyTm90RGVsZXRlIH0gZnJvbSAnQG5vZGUtbm92ZWwvdGFzay9saWIvaW5kZXgnO1xuaW1wb3J0IHsgYXJyYXlfdW5pcXVlIGFzIGFycmF5VW5pcSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5pbXBvcnQgeyBfcGF0aCB9IGZyb20gJy4uL3NjcmlwdC9zZWdtZW50JztcbmltcG9ydCAqIGFzIFByb21pc2VCbHVlYmlyZCBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgKiBhcyBGYXN0R2xvYiBmcm9tICdmYXN0LWdsb2InO1xuaW1wb3J0IGNvbnNvbGUgZnJvbSAnLi4vbGliL2xvZyc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWNoZURpZmZOb3ZlbExpc3QoZGF0YTogUmV0dXJuVHlwZTx0eXBlb2Ygbm92ZWxEaWZmRnJvbUxvZz4pXG57XG5cdGxldCBqc29uZmlsZSA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLmNhY2hlX3Jvb3QsICdkaWZmLW5vdmVsLmpzb24nKTtcblxuXHRsZXQgbHM6IHsgcGF0aE1haW46IHN0cmluZywgbm92ZWxJRDogc3RyaW5nIH1bXSA9IFtdO1xuXG5cdGlmICgwICYmIGZzLmV4aXN0c1N5bmMoanNvbmZpbGUpKVxuXHR7XG5cdFx0bHMgPSBhd2FpdCBmcy5yZWFkSlNPTihqc29uZmlsZSk7XG5cdH1cblxuXHRPYmplY3Qua2V5cyhkYXRhLmxpc3QpXG5cdFx0LmZvckVhY2goZnVuY3Rpb24gKHBhdGhNYWluKVxuXHRcdHtcblx0XHRcdGlmIChwYXRoTWFpbi5tYXRjaCgvXlxcLi8pIHx8IFsnZG9jcyddLmluY2x1ZGVzKHBhdGhNYWluKSlcblx0XHRcdHtcblx0XHRcdFx0Y29uc29sZS5ncmV5KCdbU0tJUCAoY2FjaGVEaWZmTm92ZWxMaXN0KV0nLCBwYXRoTWFpbiwgT2JqZWN0LmtleXMoZGF0YS5saXN0W3BhdGhNYWluXSkpO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdE9iamVjdC5rZXlzKGRhdGEubGlzdFtwYXRoTWFpbl0pLmZvckVhY2goZnVuY3Rpb24gKG5vdmVsSUQpXG5cdFx0XHR7XG5cdFx0XHRcdGlmICghZnMucGF0aEV4aXN0c1N5bmMocGF0aC5qb2luKFByb2plY3RDb25maWcubm92ZWxfcm9vdCwgcGF0aE1haW4sIG5vdmVsSUQsICdSRUFETUUubWQnKSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRjb25zb2xlLnJlZCgnW0NBQ0hFIChjYWNoZURpZmZOb3ZlbExpc3QpXScsICdXQVJOOiAnLCBwYXRoTWFpbiwgbm92ZWxJRCwgYFJFQURNRS5tZCDkuI3lrZjlnKhgKTtcblxuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxldCBhcnIgPSBkYXRhLmxpc3RbcGF0aE1haW5dW25vdmVsSURdLmZpbHRlcihmdW5jdGlvbiAodilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJldHVybiBfZmlsdGVyRmlsZSh2LmJhc2VuYW1lIHx8IHBhdGguYmFzZW5hbWUodi5mdWxscGF0aCkpO1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRpZiAoYXJyLmxlbmd0aClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGNvbnNvbGUub2soJ1tDQUNIRSAoY2FjaGVEaWZmTm92ZWxMaXN0KV0nLCBwYXRoTWFpbiwgbm92ZWxJRCwgZGF0YS5saXN0W3BhdGhNYWluXVtub3ZlbElEXS5sZW5ndGgsIGFyci5sZW5ndGgpO1xuXHRcdFx0XHRcdGxzLnB1c2goeyBwYXRoTWFpbiwgbm92ZWxJRCB9KVxuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Vcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGNvbnNvbGUuZ3JheSgnW1NLSVAgKGNhY2hlRGlmZk5vdmVsTGlzdCldJywgcGF0aE1haW4sIG5vdmVsSUQsIGRhdGEubGlzdFtwYXRoTWFpbl1bbm92ZWxJRF0ubGVuZ3RoKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdC8vY29uc29sZS5sb2coZGF0YS5saXN0W3BhdGhNYWluXVtub3ZlbElEXSk7XG5cdFx0XHR9KVxuXHRcdH0pXG5cdDtcblxuXHRscyA9IGFycmF5VW5pcShscy5maWx0ZXIodiA9PiB2KSk7XG5cblx0ZnMub3V0cHV0SlNPTlN5bmMoanNvbmZpbGUsIGxzLCB7XG5cdFx0c3BhY2VzOiAnXFx0Jyxcblx0fSk7XG5cblx0cmV0dXJuIGxzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2FjaGVGaWxlTGlzdChkYXRhOiBJTGlzdE5vdmVsUm93KVxue1xuXHRsZXQgZGlyID0gcGF0aC5qb2luKFByb2plY3RDb25maWcuY2FjaGVfcm9vdCwgJ2ZpbGVzJywgZGF0YS5wYXRoTWFpbik7XG5cdGxldCBmaWxlID0gcGF0aC5qb2luKGRpciwgZGF0YS5ub3ZlbElEICsgJy5qc29uJyk7XG5cblx0aWYgKCFmcy5wYXRoRXhpc3RzU3luYyhwYXRoLmpvaW4oUHJvamVjdENvbmZpZy5ub3ZlbF9yb290LCBkYXRhLnBhdGhNYWluLCBkYXRhLm5vdmVsSUQsICdSRUFETUUubWQnKSkpXG5cdHtcblx0XHRjb25zb2xlLnJlZCgnW0NBQ0hFIChjYWNoZUZpbGVMaXN0KV0nLCAnV0FSTjogJywgZGF0YS5wYXRoTWFpbiwgZGF0YS5ub3ZlbElELCBgUkVBRE1FLm1kIOS4jeWtmOWcqGApO1xuXG5cdFx0YXdhaXQgZnMucmVtb3ZlU3luYyhmaWxlKTtcblxuXHRcdHJldHVybjtcblx0fVxuXHRlbHNlIGlmIChkYXRhLnBhdGhNYWluLm1hdGNoKC9fb3V0JHxeXFwuLykgfHwgWydkb2NzJ10uaW5jbHVkZXMoZGF0YS5wYXRoTWFpbikpXG5cdHtcblx0XHRjb25zb2xlLmdyZXkoJ1tDQUNIRSAoY2FjaGVGaWxlTGlzdCldJywgJ1NLSVA6ICcsIGRhdGEucGF0aE1haW4sIGRhdGEubm92ZWxJRCk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0YXdhaXQgZnMuZW5zdXJlRGlyKGRpcik7XG5cblx0bGV0IGxzID0gW10gYXMgc3RyaW5nW107XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMoZmlsZSkpXG5cdHtcblx0XHRscyA9IGF3YWl0IGZzLnJlYWRKU09OKGZpbGUpO1xuXHR9XG5cblx0bHMgPSBsc1xuXHRcdC5jb25jYXQoZmlsdGVyTm90RGVsZXRlKGRhdGEpLm1hcChmdW5jdGlvbiAoYilcblx0e1xuXHRcdHJldHVybiBiLnN1YnBhdGg7XG5cdH0pKVxuXHRcdC5maWx0ZXIoZnVuY3Rpb24gKHYpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIF9maWx0ZXJGaWxlKHYpO1xuXHRcdH0pXG5cdDtcblxuXHRscyA9IGFycmF5VW5pcShscyk7XG5cblx0Ly8g6Ziy5q2i6Zmk5LqGIHR4dCDoiIcgcmVhZG1lIOS7peWklueahOaqlOahiOinuOeZvOabtOaWsFxuXHRpZiAobHMubGVuZ3RoID4gMClcblx0e1xuXHRcdGNvbnNvbGUub2soJ1tDQUNIRSAoY2FjaGVGaWxlTGlzdCldJywgcGF0aC5qb2luKGRhdGEucGF0aE1haW4sIGRhdGEubm92ZWxJRCArICcuanNvbicpLCBscy5sZW5ndGgpO1xuXG5cdFx0YXdhaXQgZnMub3V0cHV0SlNPTihmaWxlLCBscywge1xuXHRcdFx0c3BhY2VzOiAnXFx0Jyxcblx0XHR9KTtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRjb25zb2xlLnJlZCgnW0NBQ0hFIChjYWNoZUZpbGVMaXN0KV0nLCAnU0tJUDI6ICcsIGRhdGEucGF0aE1haW4sIGRhdGEubm92ZWxJRCk7XG5cdH1cblxuXHRyZXR1cm4gbHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfZmlsdGVyRmlsZShmaWxlOiBzdHJpbmcpXG57XG5cdGxldCBiYXNlbmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZSk7XG5cdGxldCBleHQgPSBwYXRoLmV4dG5hbWUoYmFzZW5hbWUpO1xuXG5cdGlmIChleHQgPT0gJy5tZCcgJiYgL3JlYWRtZS9pLnRlc3QoYmFzZW5hbWUpKVxuXHR7XG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblxuXHRyZXR1cm4gZXh0ID09ICcudHh0Jztcbn1cbiJdfQ==